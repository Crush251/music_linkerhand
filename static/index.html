<!--
  é’¢ç´æ¼”å¥æ§åˆ¶ç³»ç»Ÿä¸»é¡µé¢
  - æ”¯æŒå¤šCANè®¾å¤‡çš„æ‰‹éƒ¨å’Œæœºæ¢°è‡‚æ§åˆ¶
  - åŠ¨æ€ç”Ÿæˆè®¾å¤‡é¢æ¿ï¼Œæ”¯æŒå¤šç§æ§åˆ¶æ¨¡å¼

  æ˜å¤©å·¥ä½œï¼š
  1. æ‰‹éƒ¨æ§åˆ¶ï¼š
    çµå·§æ‰‹åŸå­æ“ä½œåºåˆ—æ§åˆ¶

  2. æœºæ¢°è‡‚æ§åˆ¶ï¼š
    æœºæ¢°è‡‚åŸå­æ“ä½œåºåˆ—æ§åˆ¶
    
3.æ··åˆåºåˆ—è§£ææ§åˆ¶

-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" href="/static/linker_hand_music.png" type="image/png">
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ é’¢ç´æ¼”å¥æ§åˆ¶ç³»ç»Ÿ</title>
   <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ¹ é’¢ç´æ¼”å¥æ§åˆ¶ç³»ç»Ÿ</h1>
        <div class="control-section">
            <h3>ğŸ”Œ CANæ¥å£é…ç½®</h3>
            <div class="connection-info">
                <strong>å¯ç”¨CANæ¥å£:</strong>
                <div class="interface-list" id="interfaceList">
                    <span>æ£€æµ‹ä¸­...</span>
                </div>

            </div>
                <button class="btn" onclick="refreshInterfaces()">åˆ·æ–°æ¥å£</button>

                <div class="config-grid">
                    <div class="config-item">
                        <label for="leftHandCan">å·¦æ‰‹CANæ¥å£:</label>
                        <select id="leftHandCan">
                            <option value="can0" selected>CAN0</option>
                            <option value="can1">CAN1</option>
                            <option value="can2">CAN2</option>
                            <option value="can3">CAN3</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label for="rightHandCan">å³æ‰‹CANæ¥å£:</label>
                        <select id="rightHandCan">
                            <option value="can0">CAN0</option>
                            <option value="can1" selected>CAN1</option>
                            <option value="can2">CAN2</option>
                            <option value="can3">CAN3</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label for="leftArmCan">å·¦è‡‚CANæ¥å£:</label>
                        <select id="leftArmCan">
                            <option value="can0">CAN0</option>
                            <option value="can1">CAN1</option>
                            <option value="can2" selected>CAN2</option>
                            <option value="can3">CAN3</option>
                        </select>
                    </div>
                    <div class="config-item">
                        <label for="rightArmCan">å³è‡‚CANæ¥å£:</label>
                        <select id="rightArmCan">
                            <option value="can0">CAN0</option>
                            <option value="can1">CAN1</option>
                            <option value="can2">CAN2</option>
                            <option value="can3" selected>CAN3</option>
                        </select>
                    </div>
                </div>
        </div>
        <div class="control-section">
            <h3>ğŸµ é’¢ç´æ¼”å¥é…ç½®</h3>
            <div class="file-upload-section">
                <input type="file" id="pianoFileInput" accept=".json" class="file-input">
                <label for="pianoFileInput" class="file-label">
                    <span>é€‰æ‹©JSONæ–‡ä»¶</span>
                </label>
                <span id="selectedFileName">æœªé€‰æ‹©æ–‡ä»¶</span>
            </div>
            <div class="button-group">
                <button onclick="handlePianoSequence()" class="btn">å¼€å§‹æ¼”å¥</button>
                <button onclick="stopPiano()" class="btn">æš‚åœæ¼”å¥</button>
                <button onclick="killPiano()" class="btn btn-danger">ç»ˆæ­¢æ¼”å¥</button>
            </div>
        </div>
        <div id="messageDisplay"></div>
        <div id="canDevicesContainer" class="can-devices-grid"></div>
    </div>
    <!-- å³ä¾§æ¶ˆæ¯æ—¥å¿—åŒº -->
    <div id="messageLogSidebar"></div>

    <script>

        // å…¨å±€å˜é‡
        let currentMusicData = null;

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        document.getElementById('pianoFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedFileName').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    currentMusicData = JSON.parse(e.target.result);
                    console.log("ä¹è°±åŠ è½½æˆåŠŸ:", currentMusicData);
                } catch (error) {
                    alert("æ–‡ä»¶è§£æé”™è¯¯: " + error.message);
                }
            };
            reader.readAsText(file);
        });

        // å¼€å§‹æ¼”å¥å¤„ç†
        async function handlePianoSequence() {
            if (!currentMusicData) {
                alert("è¯·å…ˆé€‰æ‹©ä¹è°±æ–‡ä»¶");
                return;
            }

            // æ”¶é›†é…ç½®ä¿¡æ¯
            const config = {
                interfaces: {
                    leftHand: document.getElementById('leftHandCan').value,
                    rightHand: document.getElementById('rightHandCan').value,
                    leftArm: document.getElementById('leftArmCan').value,
                    rightArm: document.getElementById('rightArmCan').value
                },
                musicData: currentMusicData
            };

            try {
                // å‘é€åˆ°åç«¯
                const response = await fetch('/api/piano/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || "å¯åŠ¨å¤±è´¥");
                }

                const result = await response.json();
                console.log("æ¼”å¥å¯åŠ¨æˆåŠŸ:", result);
                alert("æ¼”å¥å·²å¼€å§‹");
            } catch (error) {
                console.error("æ¼”å¥å¯åŠ¨å¤±è´¥:", error);
                alert("å¯åŠ¨å¤±è´¥: " + error.message);
            }
        }

        // æš‚åœæ¼”å¥
        function stopPiano() {
            fetch('/api/piano/stop', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log("æš‚åœæˆåŠŸ:", data);
                currentMusicData = null;
                document.getElementById('selectedFileName').textContent = "æœªé€‰æ‹©æ–‡ä»¶";
                document.getElementById('pianoFileInput').value = "";
            })
            .catch(error => {
                console.error("æš‚åœå¤±è´¥:", error);
            });
        }

        // ç»ˆæ­¢æ¼”å¥
        function killPiano() {
            fetch('/api/piano/kill', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log("åœæ­¢æˆåŠŸ:", data);
            })
            .catch(error => {
                console.error("åœæ­¢å¤±è´¥:", error);
            });
        }

        //æ¢å¤æ¼”å¥
        function resumePiano() {
            fetch('/api/piano/resume', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                console.log("æ¢å¤æˆåŠŸ:", data);
            })
            .catch(error => {
                console.error("æ¢å¤å¤±è´¥:", error);
            });
        }

        // ===================== å…¨å±€å˜é‡å’Œåˆå§‹åŒ– =====================
        // canInterfaces: å­˜å‚¨åç«¯è¿”å›çš„å¯ç”¨CANæ¥å£
        // canDeviceConfigs: å­˜å‚¨æ¯ä¸ªé¢æ¿çš„é…ç½®ï¼ˆæ¥å£ã€ç±»å‹ç­‰ï¼‰
        const canInterfaces = [];
        const canDeviceConfigs = {};
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°æ¥å£å¹¶ç”Ÿæˆé¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            refreshInterfaces();
        });

   // ===================== æ¶ˆæ¯ä¸çŠ¶æ€æ  =====================
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            let logDiv = document.getElementById('messageLogSidebar');
            if (!logDiv) return;
            const msgElem = document.createElement('div');
            msgElem.className = `message ${type}`;
            msgElem.textContent = message;
            logDiv.appendChild(msgElem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar(status, color = '#4ecdc4') {
            const statusBar = document.getElementById('statusBar');
            if (!statusBar) return;
            statusBar.textContent = `ç³»ç»ŸçŠ¶æ€: ${status}`;
            statusBar.style.background = `linear-gradient(45deg, ${color}, #764ba2)`;
        }
            


  // ===================== CANæ¥å£ä¸è®¾å¤‡é¢æ¿ =====================
        // åˆ·æ–°æ¥å£å¹¶ç”Ÿæˆè®¾å¤‡é¢æ¿
        async function refreshInterfaces() {
            try {
                const response = await fetch('/api/can_interfaces');
                const data = await response.json();
                canInterfaces.length = 0;
                canInterfaces.push(...(data.interfaces || []));
                
                const interfaceList = document.getElementById('interfaceList');
                if (canInterfaces.length > 0) {
                    interfaceList.innerHTML = canInterfaces.map(iface => 
                        `<span class="interface-tag">${iface}</span>`
                    ).join('');
                } else {
                    interfaceList.innerHTML = '<span>æœªæ£€æµ‹åˆ°æ¥å£</span>';
                }
                
                initializeCanDevices(canInterfaces.length);
            } catch (error) {
                showMessage('è·å–CANæ¥å£å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ¨æ€ç”ŸæˆCANè®¾å¤‡é¢æ¿
        function initializeCanDevices(CanDevLen) {
            const container = document.getElementById('canDevicesContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < CanDevLen; i++) {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'can-device-panel';
                deviceDiv.innerHTML = `
                    <div class="device-header">
                        <h3>CANè®¾å¤‡ ${i + 1}</h3>
                        <div class="device-config">
                            <select id="canSelect${i}" onchange="onCanInterfaceChange(${i})">
                                <option value="">é€‰æ‹©CANæ¥å£</option>
                                ${canInterfaces.map(iface => `<option value="${iface}">${iface}</option>`).join('')}
                            </select>
                            <select id="deviceType${i}" onchange="onDeviceTypeChange(${i})" disabled>
                                <option value="">é€‰æ‹©è®¾å¤‡ç±»å‹</option>
                                <option value="hand">æ‰‹éƒ¨æ§åˆ¶</option>
                                <option value="arm">æœºæ¢°è‡‚</option>
                            </select>
                        </div>
                    </div>
                    <div id="deviceContent${i}" class="device-content"></div>
                `;
                container.appendChild(deviceDiv);
            }
        }

        // é€‰æ‹©CANæ¥å£åå¯ç”¨è®¾å¤‡ç±»å‹é€‰æ‹©
        function onCanInterfaceChange(deviceIndex) {
            const canSelect = document.getElementById(`canSelect${deviceIndex}`);
            const deviceTypeSelect = document.getElementById(`deviceType${deviceIndex}`);
            
            if (canSelect.value) {
                deviceTypeSelect.disabled = false;
            } else {
                deviceTypeSelect.disabled = true;
                deviceTypeSelect.value = '';
                onDeviceTypeChange(deviceIndex);
            }
        }

        // è®¾å¤‡ç±»å‹å¤„ç†å‡½æ•°
        function onDeviceTypeChange(deviceIndex) {
            const canSelect = document.getElementById(`canSelect${deviceIndex}`);
            const deviceTypeSelect = document.getElementById(`deviceType${deviceIndex}`);
            const contentDiv = document.getElementById(`deviceContent${deviceIndex}`);
            
            if (!canSelect.value || !deviceTypeSelect.value) {
                contentDiv.innerHTML = '';
                return;
            }

            const canInterface = canSelect.value;
            const deviceType = deviceTypeSelect.value;
            
            canDeviceConfigs[deviceIndex] = {
                canInterface: canInterface,
                deviceType: deviceType
            };

            if (deviceType === 'hand') {
                renderHandTypeSelection(deviceIndex, contentDiv);
            } else if (deviceType === 'arm') {
                canDeviceConfigs[deviceIndex].armSide = 'left';
                canDeviceConfigs[deviceIndex].armMode = 'P';
                renderArmControl(deviceIndex, contentDiv, true);
            }
        }

        // æ¸²æŸ“æ‰‹å‹é€‰æ‹©
        function renderHandTypeSelection(deviceIndex, contentDiv) {
            contentDiv.innerHTML = `
                <div class="hand-type-selection">
                    <h4>é€‰æ‹©æ‰‹å‹</h4>
                    <div class="hand-type-options">
                        <label>
                            <input type="radio" name="handModel${deviceIndex}" value="o7" checked 
                                onchange="onHandModelChange(${deviceIndex})"> O7æ‰‹å‹
                        </label>
                        <label>
                            <input type="radio" name="handModel${deviceIndex}" value="l10" 
                                onchange="onHandModelChange(${deviceIndex})"> L10æ‰‹å‹
                        </label>
                    </div>
                    <div id="handControlPanel${deviceIndex}"></div>
                </div>
            `;
            onHandModelChange(deviceIndex);
        }

        // æ‰‹å‹å˜æ›´å¤„ç†
        function onHandModelChange(deviceIndex) {
            const handModel = document.querySelector(`input[name="handModel${deviceIndex}"]:checked`).value;
            canDeviceConfigs[deviceIndex].handModel = handModel;
            canDeviceConfigs[deviceIndex].handSide = 'left';
            
            const handContentDiv = document.getElementById(`handControlPanel${deviceIndex}`);
            
            if (handModel === 'o7') {
                renderO7HandControl(deviceIndex, handContentDiv);
            } else {
                renderL10HandControl(deviceIndex, handContentDiv);
            }
        }

        // æ¸²æŸ“O7æ‰‹å‹æ§åˆ¶
        function renderO7HandControl(deviceIndex, contentDiv) {
            contentDiv.innerHTML = `
                <div class="hand-control">
                    <div class="hand-side-selection">
                        <label><input type="radio" name="handSide${deviceIndex}" value="left" checked 
                            onchange="updateHandSide(${deviceIndex})"> å·¦æ‰‹</label>
                        <label><input type="radio" name="handSide${deviceIndex}" value="right" 
                            onchange="updateHandSide(${deviceIndex})"> å³æ‰‹</label>
                    </div>
                    
                    <div class="slider-control">
                        <h4>æ‰‹æŒ‡æ§åˆ¶</h4>
                        <div class="mode-selector">
                            <label><input type="radio" name="controlMode${deviceIndex}" value="0x01" checked> å¼¯æ›²æ§åˆ¶</label>
                            <label><input type="radio" name="controlMode${deviceIndex}" value="0x05"> é€Ÿåº¦æ§åˆ¶</label>
                        </div>
                        <div id="fingerSliders${deviceIndex}"></div>
                    </div>
                    
                    <button onclick="updateHandPreset(${deviceIndex})">æ›´æ–°å¼¹ç´é¢„è®¾å€¼</button>
                </div>
            `;
            initO7FingerSliders(deviceIndex);
        }

        // åˆå§‹åŒ–O7æ‰‹å‹æ»‘å—æ§åˆ¶
        function initO7FingerSliders(deviceIndex) {
            const fingerNames = [
                "æ‹‡æŒ‡å¼¯æ›²", "æ‹‡æŒ‡æ ¹éƒ¨å·¦å³", "é£ŸæŒ‡å¼¯æ›²", "ä¸­æŒ‡å¼¯æ›²", 
                "æ— åæŒ‡å¼¯æ›²", "å°æ‹‡æŒ‡å¼¯æ›²", "å¤§æ‹‡æŒ‡ä¸Šä¸‹"
            ];
            
            const slidersContainer = document.getElementById(`fingerSliders${deviceIndex}`);
            slidersContainer.innerHTML = '';
            
            fingerNames.forEach((name, index) => {
                const container = document.createElement('div');
                container.className = 'slider-container';
                
                const label = document.createElement('div');
                label.className = 'slider-label';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'finger-name';
                nameSpan.textContent = name;
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'value';
                valueSpan.textContent = '128';
                
                const inputBox = document.createElement('input');
                inputBox.type = 'number';
                inputBox.min = '0';
                inputBox.max = '255';
                inputBox.value = '128';
                inputBox.className = 'value-input';
                inputBox.addEventListener('input', function() {
                    const value = Math.max(0, Math.min(255, parseInt(this.value) || 0));
                    this.value = value;
                    slider.value = value;
                    valueSpan.textContent = value;
                    sendO7FingerControl(deviceIndex);
                });
                
                label.appendChild(nameSpan);
                label.appendChild(valueSpan);
                label.appendChild(inputBox);
                
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = '0';
                slider.max = '255';
                slider.value = '128';
                slider.dataset.index = index;
                
                slider.addEventListener('input', function() {
                    const value = this.value;
                    valueSpan.textContent = value;
                    inputBox.value = value;
                });
                
                slider.addEventListener('change', function() {
                    sendO7FingerControl(deviceIndex);
                });
                
                container.appendChild(label);
                container.appendChild(slider);
                slidersContainer.appendChild(container);
            });
        }

        // å‘é€O7æ‰‹å‹æ§åˆ¶æŒ‡ä»¤ - ä¿®å¤åçš„ç‰ˆæœ¬
        async function sendO7FingerControl(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config || config.handModel !== 'o7') return;
            
            const mode = document.querySelector(`input[name="controlMode${deviceIndex}"]:checked`).value;
            const sliders = document.querySelectorAll(`#fingerSliders${deviceIndex} input[type="range"]`);
            
            // æ„å»ºæ•°æ®åŒ…ï¼šæŒ‡ä»¤ç  + 7ä¸ªå…³èŠ‚å€¼
            const data = [parseInt(mode, 16)];
            sliders.forEach(slider => {
                data.push(parseInt(slider.value));
            });
            
            // è¡¥å…¨8å­—èŠ‚æ•°æ®
            while (data.length < 8) {
                data.push(0);
            }
            
            try {
                const response = await fetch('/api/hand/o7/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interface: config.canInterface,
                        id: config.handSide === 'left' ? 0x28 : 0x27,//æ˜¯leftçš„è¯ï¼Œidæ˜¯0x28ï¼Œæ˜¯rightçš„è¯ï¼Œidæ˜¯0x27
                        data: data
                    })
                });
                
                if (!response.ok) {
                    const result = await response.json();
                    showMessage(`O7æ‰‹æŒ‡æ§åˆ¶å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`O7æ‰‹æŒ‡æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸²æŸ“L10æ‰‹å‹æ§åˆ¶
        function renderL10HandControl(deviceIndex, contentDiv) {
            contentDiv.innerHTML = `
                <div class="hand-control">
                    <div class="hand-side-selection">
                        <label><input type="radio" name="handSide${deviceIndex}" value="left" checked 
                            onchange="updateHandSide(${deviceIndex})"> å·¦æ‰‹</label>
                        <label><input type="radio" name="handSide${deviceIndex}" value="right" 
                            onchange="updateHandSide(${deviceIndex})"> å³æ‰‹</label>
                    </div>
                    
                    <div class="l10-controls">
                        <div class="control-group">
                            <h4>å…³èŠ‚1-6æ§åˆ¶ (0x01æŒ‡ä»¤)</h4>
                            <div id="l10Joint1to6Sliders${deviceIndex}"></div>
                        </div>
                        
                        <div class="control-group">
                            <h4>å…³èŠ‚7-10æ§åˆ¶ (0x04æŒ‡ä»¤)</h4>
                            <div id="l10Joint7to10Sliders${deviceIndex}"></div>
                        </div>
                        
                        <div class="control-group">
                            <h4>é€Ÿåº¦æ§åˆ¶ (0x05æŒ‡ä»¤)</h4>
                            <div class="speed-control">
                                <label>å…¨å±€é€Ÿåº¦:</label>
                                <input type="range" id="l10SpeedSlider${deviceIndex}" min="0" max="255" value="128">
                                <span id="l10SpeedValue${deviceIndex}">128</span>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="updateHandPreset(${deviceIndex})">æ›´æ–°å¼¹ç´é¢„è®¾å€¼</button>
                </div>
            `;
            initL10FingerSliders(deviceIndex);
        }

        // æ›´æ–°æ‰‹éƒ¨å·¦å³é€‰æ‹©
        function updateHandSide(deviceIndex) {
            canDeviceConfigs[deviceIndex].handSide = 
                document.querySelector(`input[name="handSide${deviceIndex}"]:checked`).value;
        }

        // åˆå§‹åŒ–L10æ‰‹æŒ‡æ»‘å—
        function initL10FingerSliders(deviceIndex) {
            // å…³èŠ‚1-6æ»‘å—
            const joint1to6Container = document.getElementById(`l10Joint1to6Sliders${deviceIndex}`);
            joint1to6Container.innerHTML = '';
            
            ['æ‹‡æŒ‡å¼¯æ›²', 'æ‹‡æŒ‡æ ¹éƒ¨å·¦å³', 'é£ŸæŒ‡å¼¯æ›²', 'ä¸­æŒ‡å¼¯æ›²', 'æ— åæŒ‡å¼¯æ›²', 'å°æ‹‡æŒ‡å¼¯æ›²'].forEach((name, index) => {
                joint1to6Container.innerHTML += `
                    <div class="slider-container">
                        <label>${name}:</label>
                        <input type="range" class="joint-slider" data-joint="${index+1}" min="0" max="255" value="128">
                        <span class="slider-value">128</span>
                    </div>
                `;
            });
            
            // å…³èŠ‚7-10æ»‘å—
            const joint7to10Container = document.getElementById(`l10Joint7to10Sliders${deviceIndex}`);
            joint7to10Container.innerHTML = '';
            
            ['é£ŸæŒ‡å¼ å¼€', 'ä¸­æŒ‡å¼ å¼€', 'å°æ‹‡æŒ‡å¼ å¼€', 'å¤§æ‹‡æŒ‡'].forEach((name, index) => {
                joint7to10Container.innerHTML += `
                    <div class="slider-container">
                        <label>${name}:</label>
                        <input type="range" class="joint-slider" data-joint="${index+7}" min="0" max="255" value="128">
                        <span class="slider-value">128</span>
                    </div>
                `;
            });
            
            // æ»‘å—äº‹ä»¶ç»‘å®š
            document.querySelectorAll(`#l10Joint1to6Sliders${deviceIndex} .joint-slider, 
                                    #l10Joint7to10Sliders${deviceIndex} .joint-slider`).forEach(slider => {
                slider.addEventListener('input', function() {
                    this.nextElementSibling.textContent = this.value;
                });
                slider.addEventListener('change', function() {
                    sendL10ControlCommand(deviceIndex);
                });
            });
            
            // é€Ÿåº¦æ»‘å—
            const speedSlider = document.getElementById(`l10SpeedSlider${deviceIndex}`);
            speedSlider.addEventListener('input', function() {
                document.getElementById(`l10SpeedValue${deviceIndex}`).textContent = this.value;
            });
            speedSlider.addEventListener('change', function() {
                sendL10SpeedCommand(deviceIndex);
            });
        }

        // å‘é€L10æ§åˆ¶æŒ‡ä»¤ - ä¿®å¤åçš„ç‰ˆæœ¬
        async function sendL10ControlCommand(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            // è·å–å…³èŠ‚1-6çš„å€¼
            const joint1to6Values = [];
            document.querySelectorAll(`#l10Joint1to6Sliders${deviceIndex} .joint-slider`).forEach(slider => {
                joint1to6Values.push(parseInt(slider.value));
            });
            
            // è·å–å…³èŠ‚7-10çš„å€¼  
            const joint7to10Values = [];
            document.querySelectorAll(`#l10Joint7to10Sliders${deviceIndex} .joint-slider`).forEach(slider => {
                joint7to10Values.push(parseInt(slider.value));
            });
            
            // å‘é€å…³èŠ‚1-6æ§åˆ¶æŒ‡ä»¤
            try {
                await fetch('/api/hand/l10/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interface: config.canInterface,
                        id: config.handSide === 'left' ? 0x28 : 0x27,
                        data: [0x01, ...joint1to6Values]  // æŠŠ cmd æ”¾åœ¨ data çš„ç¬¬ä¸€ä½
                    })
                });
                
                // å‘é€å…³èŠ‚7-10æ§åˆ¶æŒ‡ä»¤
                await fetch('/api/hand/l10/control', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interface: config.canInterface,
                        id: config.handSide === 'left' ? 0x28 : 0x27,
                        data: [0x04, ... joint7to10Values]  // æŠŠ cmd æ”¾åœ¨ data çš„ç¬¬ä¸€ä½
                    })
                });
            } catch (error) {
                showMessage(`L10æ§åˆ¶æŒ‡ä»¤å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å‘é€L10é€Ÿåº¦æŒ‡ä»¤
        async function sendL10SpeedCommand(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            const speedValue = parseInt(document.getElementById(`l10SpeedSlider${deviceIndex}`).value);
            const speedValues = Array(5).fill(speedValue); // L10æœ‰5ä¸ªæ‰‹æŒ‡
            
            try {
                await fetch('/api/hand/l10/speed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interface: config.canInterface,
                        id: config.handSide === 'left' ? 0x28 : 0x27,
                        data: [0x05, ...speedValues]  // æŠŠ cmd æ”¾åœ¨ data çš„ç¬¬ä¸€ä½
                    })
                });
            } catch (error) {
                showMessage(`L10é€Ÿåº¦æŒ‡ä»¤å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°æ‰‹éƒ¨å¼¹ç´é¢„è®¾å€¼ - ä¿®å¤åçš„ç‰ˆæœ¬
        async function updateHandPreset(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config || config.deviceType !== 'hand') return;
            
            try {
                        let presetData;
                        if (config.handModel === 'o7') {
                            // O7é¢„è®¾å€¼æ”¶é›†
                            const values = [];
                            document.querySelectorAll(`#fingerSliders${deviceIndex} input[type="range"]`)
                                .forEach(s => values.push(parseInt(s.value)));
                            presetData = { values: values };
                        } else {
                            // L10é¢„è®¾å€¼æ”¶é›†ï¼Œåªæ”¶é›†5ä¸ªæ‰‹æŒ‡çš„
                            const values = [];
                            document.querySelectorAll(`#l10Joint1to6Sliders${deviceIndex} .joint-slider`)
                                .forEach(s => values.push(parseInt(s.value)));
                            presetData = { values: values };
                            console.log(presetData);
                        }
                        
                        const response = await fetch(`/api/hand/${config.handModel}/piano_preset`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(presetData)
                        });
                        
                        if (response.ok) {
                            showMessage(`${config.handModel.toUpperCase()}å¼¹ç´é¢„è®¾å€¼å·²æ›´æ–°`);
                        } else {
                            showMessage(`${config.handModel.toUpperCase()}å¼¹ç´é¢„è®¾å€¼æ›´æ–°å¤±è´¥`, 'error');
                        }
                    } catch (error) {
                        showMessage(`å¼¹ç´é¢„è®¾å€¼æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
                    }
                }

        // è¾…åŠ©å‡½æ•°ï¼šæ”¶é›†æ»‘å—å€¼
        function collectSliderValues(selector) {
            const values = [];
            document.querySelectorAll(selector).forEach(s => values.push(parseInt(s.value)));
            return values;
        }


        // ===================== æœºæ¢°è‡‚æ§åˆ¶ç›¸å…³ =====================
        // æ¸²æŸ“æœºæ¢°è‡‚æ§åˆ¶åŒºï¼Œç›´æ¥æ˜¾ç¤ºå·¦å³è‡‚é€‰æ‹©å’ŒPæ¨¡å¼å†…å®¹
        function renderArmControl(deviceIndex, contentDiv, autoShow) {
            const armSide = canDeviceConfigs[deviceIndex].armSide || 'left';
            contentDiv.innerHTML = `
                <div class="arm-control">
                    <div class="arm-side-selection">
                        <label>
                            <input type="radio" name="armSide${deviceIndex}" value="left" ${armSide==='left'?'checked':''} onchange="onArmSideChange(${deviceIndex})"> å·¦è‡‚
                        </label>
                        <label>
                            <input type="radio" name="armSide${deviceIndex}" value="right" ${armSide==='right'?'checked':''} onchange="onArmSideChange(${deviceIndex})"> å³è‡‚
                        </label>
                    </div>
                    <div class="arm-basic-controls">
                        <button class="btn btn-success" onclick="enableArm(${deviceIndex})">ä½¿èƒ½</button>
                        <button class="btn btn-danger" onclick="disableArm(${deviceIndex})">å¤±èƒ½</button>
                        <button class="btn btn-danger" onclick="emergencyStop(${deviceIndex})">ğŸ›‘ æ€¥åœ</button>
                        <button class="btn btn-success" onclick="emergencyResume(${deviceIndex})">â–¶ï¸ æ¢å¤</button>
                        <button class="btn" onclick="toZero(${deviceIndex})">å›é›¶</button>
                        <button class="btn btn-set-to-zero" onclick="setToZero(${deviceIndex})">è®¾ç½®é›¶ç‚¹</button>
                    </div>
                    <div class="arm-mode-selection">
                        <label>
                            <input type="radio" name="armMode${deviceIndex}" value="J" onchange="onArmModeChange(${deviceIndex})"> å…³èŠ‚æ¨¡å¼(J)
                        </label>
                        <label>
                            <input type="radio" name="armMode${deviceIndex}" value="P" checked onchange="onArmModeChange(${deviceIndex})"> ä½å§¿æ¨¡å¼(P)
                        </label>
                    </div>
                    <div id="armModeContent${deviceIndex}" class="arm-mode-content"></div>
                </div>
            `;
            // é»˜è®¤Pæ¨¡å¼ï¼Œç¡®ä¿æ¸²æŸ“
            setTimeout(()=>{
                renderPoseControl(deviceIndex, document.getElementById(`armModeContent${deviceIndex}`));
            },0);
        }

        function onArmSideChange(deviceIndex) {
            const side = document.querySelector(`input[name="armSide${deviceIndex}"]:checked`)?.value;
            canDeviceConfigs[deviceIndex].armSide = side;
        }

        function onArmModeChange(deviceIndex) {
            const armMode = document.querySelector(`input[name="armMode${deviceIndex}"]:checked`)?.value;
            canDeviceConfigs[deviceIndex].armMode = armMode;
            const armModeContentDiv = document.getElementById(`armModeContent${deviceIndex}`);
            if (armMode === 'J') {
                renderJointControl(deviceIndex, armModeContentDiv);
            } else if (armMode === 'P'){
                renderPoseControl(deviceIndex, armModeContentDiv);
            }
        }

        // æ¸²æŸ“å…³èŠ‚æ§åˆ¶åŒº
        function renderJointControl(deviceIndex, contentDiv) {
            contentDiv.innerHTML = `
                <div class="joint-control">
                    <h4>å…³èŠ‚æ§åˆ¶</h4>
                    <div class="joint-inputs">
                        ${[1,2,3,4,5,6].map(i => `
                            <div class="form-group">
                                <label>J${i} è§’åº¦ (Â°): <span class="range-value" id="j${i}Value${deviceIndex}">0.000</span></label>
                                <input type="number" id="j${i}Input${deviceIndex}" value="0" step="0.001" 
                                       onchange="updateJointFromInput(${deviceIndex}, ${i})">
                                <div class="range-container">
                                    <input type="range" id="j${i}Range${deviceIndex}" 
                                           min="${getJointMin(i)}" max="${getJointMax(i)}" value="0" step="1" 
                                           oninput="updateJointFromSlider(${deviceIndex}, ${i})">
            </div>
        </div>
                        `).join('')}
                    </div>
            <div class="form-group">
                        <label>è¿åŠ¨é€Ÿåº¦ (%):</label>
                        <input type="number" id="speedInput${deviceIndex}" value="50" min="0" max="100" 
                               onchange="updateSpeedFromInput(${deviceIndex})">
                        <div class="range-container">
                            <input type="range" id="speedRange${deviceIndex}" min="0" max="100" value="50" 
                                   oninput="updateSpeedFromSlider(${deviceIndex})">
                            <span class="range-value" id="speedValue${deviceIndex}">50</span>
                        </div>
            </div>
        </div>
            `;
        }
        // æ¸²æŸ“ä½å§¿æ§åˆ¶åŒº
        function renderPoseControl(deviceIndex, contentDiv) {
    contentDiv.innerHTML = `
        <div class="pose-control">
            <h4>ä½å§¿æ§åˆ¶</h4>
            <div class="pose-inputs">
                <div class="form-group">
                    <label>X åæ ‡ (mm): <span class="range-value" id="poseXValue${deviceIndex}">400.000</span></label>
                    <input type="number" id="poseXInput${deviceIndex}" value="400" min="300" max="500" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'X')">
                    <div class="range-container">
                        <input type="range" id="poseXRange${deviceIndex}" min="300000" max="500000" value="400000" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'X')">
                    </div>
                </div>
                <div class="form-group">
                    <label>Y åæ ‡ (mm): <span class="range-value" id="poseYValue${deviceIndex}">0.000</span></label>
                    <input type="number" id="poseYInput${deviceIndex}" value="0" min="-150" max="150" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'Y')">
                    <div class="range-container">
                        <input type="range" id="poseYRange${deviceIndex}" min="-150000" max="150000" value="0" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'Y')">
                    </div>
                </div>
                <div class="form-group">
                    <label>Z åæ ‡ (mm): <span class="range-value" id="poseZValue${deviceIndex}">170.000</span></label>
                    <input type="number" id="poseZInput${deviceIndex}" value="170" min="0" max="300" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'Z')">
                    <div class="range-container">
                        <input type="range" id="poseZRange${deviceIndex}" min="0" max="300000" value="170000" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'Z')">
                    </div>
                </div>
                <div class="form-group">
                    <label>RX (Â°): <span class="range-value" id="poseRXValue${deviceIndex}">0.000</span></label>
                    <input type="number" id="poseRXInput${deviceIndex}" value="0" min="-180" max="180" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'RX')">
                    <div class="range-container">
                        <input type="range" id="poseRXRange${deviceIndex}" min="-180000" max="180000" value="0" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'RX')">
                    </div>
                </div>
                <div class="form-group">
                    <label>RY (Â°): <span class="range-value" id="poseRYValue${deviceIndex}">80.000</span></label>
                    <input type="number" id="poseRYInput${deviceIndex}" value="80" min="70" max="90" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'RY')">
                    <div class="range-container">
                        <input type="range" id="poseRYRange${deviceIndex}" min="70000" max="90000" value="80000" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'RY')">
                    </div>
                </div>
                <div class="form-group">
                    <label>RZ (Â°): <span class="range-value" id="poseRZValue${deviceIndex}">0.000</span></label>
                    <input type="number" id="poseRZInput${deviceIndex}" value="0" min="-180" max="180" step="1" onchange="updatePoseFromInput(${deviceIndex}, 'RZ')">
                    <div class="range-container">
                        <input type="range" id="poseRZRange${deviceIndex}" min="-180000" max="180000" value="0" step="100" oninput="updatePoseFromSlider(${deviceIndex}, 'RZ')">
                </div>
            </div>
            <div class="form-group">
                <label>è¿åŠ¨é€Ÿåº¦ (%):</label>
                    <input type="number" id="poseSpeedInput${deviceIndex}" value="50" min="0" max="100" step="1" onchange="updatePoseSpeedFromInput(${deviceIndex})">
                <div class="range-container">
                        <input type="range" id="poseSpeedRange${deviceIndex}" min="0" max="100" value="50" step="1" oninput="updatePoseSpeedFromSlider(${deviceIndex})">
                        <span class="range-value" id="poseSpeedValue${deviceIndex}">50</span>
                    </div>
                </div>
                <button class="btn btn-success" onclick="sendPoseCommand(${deviceIndex})">å‘é€ä½å§¿</button>
            </div>
        </div>
           <button onclick="updateArmPianoPreset(${deviceIndex})">æ›´æ–°${getArmSideLabel(deviceIndex)}å¼¹ç´é¢„è®¾å€¼</button>

    `;
}
        function getArmSideLabel(deviceIndex) {
            const side = canDeviceConfigs[deviceIndex]?.armSide;
            return side === 'right' ? 'å³è‡‚' : 'å·¦è‡‚';
        }
        // æ›´æ–°æ‰‹è‡‚å¼¹ç´ä½å§¿é¢„è®¾å€¼ï¼Œå‘é€çš„æ˜¯ä½å§¿çš„å€¼
        function updateArmPianoPreset(deviceIndex) {
        const config = canDeviceConfigs[deviceIndex];
        if (!config) return;
        // å–Pæ¨¡å¼ä¸‹6ä¸ªæ»‘å—çš„å€¼
        const axes = ['X', 'Y', 'Z', 'RX', 'RY', 'RZ'];
        const values = axes.map(axis => parseInt(document.getElementById(`pose${axis}Range${deviceIndex}`)?.value || 0));
        fetch('/api/arm/arm_piano_preset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ side: config.armSide, values: values })
        }).then(res => res.json()).then(data => {



            if (data.status === 'success') {
                showMessage(`${getArmSideLabel(deviceIndex)}å¼¹ç´é¢„è®¾å€¼å·²æ›´æ–°`);
            } else {
                showMessage(`${getArmSideLabel(deviceIndex)}å¼¹ç´é¢„è®¾å€¼æ›´æ–°å¤±è´¥`, 'error');
            }
        }).catch(err => {
            showMessage(`${getArmSideLabel(deviceIndex)}å¼¹ç´é¢„è®¾å€¼æ›´æ–°å¤±è´¥: ` + err, 'error');
        });
    }

        // å…³èŠ‚è§’åº¦èŒƒå›´
        function getJointMin(jointIndex) {
            const mins = [-154000, 0, -175000, -102000, -75000, -120000];
            return mins[jointIndex - 1];
        }

        function getJointMax(jointIndex) {
            const maxs = [154000, 195000, 0, 102000, 75000, 120000];
            return maxs[jointIndex - 1];
        }

        // å…³èŠ‚è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updateJointFromInput(deviceIndex, jointIndex) {
            const input = document.getElementById(`j${jointIndex}Input${deviceIndex}`);
            const slider = document.getElementById(`j${jointIndex}Range${deviceIndex}`);
            const valueDisplay = document.getElementById(`j${jointIndex}Value${deviceIndex}`);
            
            const value = parseFloat(input.value) * 1000;
            slider.value = value;
            valueDisplay.textContent = input.value;
            
            sendJointCommand(deviceIndex);
        }

        function updateJointFromSlider(deviceIndex, jointIndex) {
            const slider = document.getElementById(`j${jointIndex}Range${deviceIndex}`);
            const input = document.getElementById(`j${jointIndex}Input${deviceIndex}`);
            const valueDisplay = document.getElementById(`j${jointIndex}Value${deviceIndex}`);
            
            const value = (parseInt(slider.value) / 1000);
            input.value = value.toFixed(3);
            valueDisplay.textContent = value.toFixed(3);
            
            sendJointCommand(deviceIndex);
        }

        // é€Ÿåº¦è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updateSpeedFromInput(deviceIndex) {
            const input = document.getElementById(`speedInput${deviceIndex}`);
            const slider = document.getElementById(`speedRange${deviceIndex}`);
            const valueDisplay = document.getElementById(`speedValue${deviceIndex}`);
            
            slider.value = input.value;
            valueDisplay.textContent = input.value;
        }
        // å…³èŠ‚é€Ÿåº¦è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updateSpeedFromSlider(deviceIndex) {
            const slider = document.getElementById(`speedRange${deviceIndex}`);
            const input = document.getElementById(`speedInput${deviceIndex}`);
            const valueDisplay = document.getElementById(`speedValue${deviceIndex}`);
            
            input.value = slider.value;
            valueDisplay.textContent = slider.value;
        }

        // å…³èŠ‚æŒ‡ä»¤é˜²æŠ–å¹¶å‘é€
        let jointCommandTimeouts = {};
        async function sendJointCommand(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            if (jointCommandTimeouts[deviceIndex]) {
                clearTimeout(jointCommandTimeouts[deviceIndex]);
            }
            
            jointCommandTimeouts[deviceIndex] = setTimeout(async () => {
                const jointData = {
                    interface: config.canInterface,
                    j1: parseInt(document.getElementById(`j1Range${deviceIndex}`)?.value || 0),
                    j2: parseInt(document.getElementById(`j2Range${deviceIndex}`)?.value || 0),
                    j3: parseInt(document.getElementById(`j3Range${deviceIndex}`)?.value || 0),
                    j4: parseInt(document.getElementById(`j4Range${deviceIndex}`)?.value || 0),
                    j5: parseInt(document.getElementById(`j5Range${deviceIndex}`)?.value || 0),
                    j6: parseInt(document.getElementById(`j6Range${deviceIndex}`)?.value || 0),
                    speed: parseInt(document.getElementById(`speedRange${deviceIndex}`)?.value || 50)
                };
                
                try {
                    const response = await fetch('/api/arm/send_joint', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(jointData)
                    });
                    
                    if (!response.ok) {
                        const result = await response.json();
                        showMessage(`å…³èŠ‚æ§åˆ¶å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    showMessage(`å…³èŠ‚æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
                }
            }, 100);
        }

                // æ»‘å—ä¸è¾“å…¥æ¡†è”åŠ¨
        function updatePoseFromInput(deviceIndex, axis) {
            const input = document.getElementById(`pose${axis}Input${deviceIndex}`);
            const range = document.getElementById(`pose${axis}Range${deviceIndex}`);
            const valueDisplay = document.getElementById(`pose${axis}Value${deviceIndex}`);
            let value = parseFloat(input.value);
            if (axis === 'X' || axis === 'Y' || axis === 'Z') value = value * 1000;
            range.value = value;
            valueDisplay.textContent = (value / 1000).toFixed(3);
            sendPoseCommand(deviceIndex);
        }
        // ä½å§¿è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updatePoseFromSlider(deviceIndex, axis) {
            const range = document.getElementById(`pose${axis}Range${deviceIndex}`);
            const input = document.getElementById(`pose${axis}Input${deviceIndex}`);
            const valueDisplay = document.getElementById(`pose${axis}Value${deviceIndex}`);
            let value = parseInt(range.value);
            input.value = (value / 1000).toFixed(3);
            valueDisplay.textContent = (value / 1000).toFixed(3);
            sendPoseCommand(deviceIndex);
        }
        // ä½å§¿é€Ÿåº¦è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updatePoseSpeedFromInput(deviceIndex) {
            const input = document.getElementById(`poseSpeedInput${deviceIndex}`);
            const range = document.getElementById(`poseSpeedRange${deviceIndex}`);
            const valueDisplay = document.getElementById(`poseSpeedValue${deviceIndex}`);
            range.value = input.value;
            valueDisplay.textContent = input.value;
        }
        // ä½å§¿é€Ÿåº¦è¾“å…¥ä¸æ»‘å—è”åŠ¨
        function updatePoseSpeedFromSlider(deviceIndex) {
            const range = document.getElementById(`poseSpeedRange${deviceIndex}`);
            const input = document.getElementById(`poseSpeedInput${deviceIndex}`);
            const valueDisplay = document.getElementById(`poseSpeedValue${deviceIndex}`);
            input.value = range.value;
            valueDisplay.textContent = range.value;
        }

        // å‘é€ä½å§¿æŒ‡ä»¤
        async function sendPoseCommand(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            // å–å€¼å¹¶è½¬ä¸º0.001å•ä½
            const poseData = {
                interface: config.canInterface,
                x: parseInt(document.getElementById(`poseXRange${deviceIndex}`).value),
                y: parseInt(document.getElementById(`poseYRange${deviceIndex}`).value),
                z: parseInt(document.getElementById(`poseZRange${deviceIndex}`).value),
                rx: parseInt(document.getElementById(`poseRXRange${deviceIndex}`).value),
                ry: parseInt(document.getElementById(`poseRYRange${deviceIndex}`).value),
                rz: parseInt(document.getElementById(`poseRZRange${deviceIndex}`).value),
                speed: parseInt(document.getElementById(`poseSpeedRange${deviceIndex}`).value)
            };
            try {
                const response = await fetch('/api/arm/send_pose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(poseData)
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} ä½å§¿æŒ‡ä»¤å‘é€æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} ä½å§¿æŒ‡ä»¤å‘é€å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`ä½å§¿æŒ‡ä»¤å‘é€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        // æœºæ¢°è‡‚åŸºç¡€æ“ä½œ
        
        // ä½¿èƒ½æœºæ¢°è‡‚
        async function enableArm(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            try {
                const response = await fetch('/api/arm/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚ä½¿èƒ½æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚ä½¿èƒ½å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚ä½¿èƒ½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        // å¤±èƒ½æœºæ¢°è‡‚
        async function disableArm(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;

            try {
                const response = await fetch('/api/arm/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚å¤±èƒ½æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚å¤±èƒ½å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚å¤±èƒ½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        // æ€¥åœæœºæ¢°è‡‚
        async function emergencyStop(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;

            try {
                const response = await fetch('/api/arm/emergency_stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚æ€¥åœæˆåŠŸ`, 'error');
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚æ€¥åœå¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚æ€¥åœå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function emergencyResume(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            try {
                const response = await fetch('/api/arm/emergency_resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚æ¢å¤æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚æ¢å¤å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚æ¢å¤å¤±è´¥: ${error.message}`, 'error');
            }
        }
        // å›é›¶æœºæ¢°è‡‚
        async function toZero(deviceIndex) {
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            try {
                const response = await fetch('/api/arm/to_zero', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });
                
                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚å›é›¶æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚å›é›¶å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚å›é›¶å¤±è´¥: ${error.message}`, 'error');
            }
        }
        // è®¾ç½®æœºæ¢°è‡‚å…³èŠ‚çš„é›¶ç‚¹ä½ç½®ï¼Œéœ€è¦æ”¹ä¸€ä¸‹ï¼Œå½“å‰æ˜¯è®¾ç½®ä¸€ä¸ªå…³èŠ‚çš„é›¶ç‚¹ä½ç½®ï¼Œéœ€è¦è®¾ç½®æ‰€æœ‰å…³èŠ‚çš„é›¶ç‚¹ä½ç½®
        async function setToZero(deviceIndex) {
            //deviceIndexæ˜¯æœºæ¢°è‡‚çš„ç´¢å¼•ï¼Œä»0å¼€å§‹
            const config = canDeviceConfigs[deviceIndex];
            if (!config) return;
            
            try {
                const response = await fetch('/api/arm/set_zero', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface: config.canInterface })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚è®¾ç½®é›¶ç‚¹æˆåŠŸ`);
                } else {
                    showMessage(`${config.canInterface} æœºæ¢°è‡‚è®¾ç½®é›¶ç‚¹å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                showMessage(`æœºæ¢°è‡‚è®¾ç½®é›¶ç‚¹å¤±è´¥: ${error.message}`, 'error');
            }
        }

   
   </script>
</body>
</html>