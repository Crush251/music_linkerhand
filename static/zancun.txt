<h2>ğŸ“ ä½å§¿æ§åˆ¶ (0x152/153/154)P (ç‚¹ä½)</h2>

</div>
<div id="poseInputs">
    <div class="pose-inputs">
        <div class="form-group">
            <label>X åæ ‡ (mm): <span class="range-value" id="poseXValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseX" min="300000" max="500000" value="0" step="100" oninput="handlePoseChange('poseX')">
            </div>
        </div>
        <div class="form-group">
            <label>Y åæ ‡ (mm): <span class="range-value" id="poseYValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseY" min="-150000" max="150000" value="0" step="100" oninput="handlePoseChange('poseY')">
            </div>
        </div>
        <div class="form-group">
            <label>Z åæ ‡ (mm): <span class="range-value" id="poseZValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseZ" min="100000" max="300000" value="0" step="100" oninput="handlePoseChange('poseZ')">
            </div>
        </div>
        <div class="form-group">
            <label>RX æ—‹è½¬ (Â°): <span class="range-value" id="poseRXValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseRX" min="000" max="000" value="0" step="100" oninput="handlePoseChange('poseRX')">
            </div>
        </div>
        <div class="form-group">
            <label>RY æ—‹è½¬ (Â°): <span class="range-value" id="poseRYValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseRY" min="70000" max="90000" value="0" step="100" oninput="handlePoseChange('poseRY')">
            </div>
        </div>
        <div class="form-group">
            <label>RZ æ—‹è½¬ (Â°): <span class="range-value" id="poseRZValue">0.000</span></label>
            <div class="range-container">
                <input type="range" id="poseRZ" min="0000" max="0000" value="0" step="100" oninput="handlePoseChange('poseRZ')">
            </div>
        </div>
    </div>
</div>

// å¤„ç†ä½å§¿å€¼å˜åŒ–
let poseChangeTimeout;
function handlePoseChange(poseId) {
    const slider = document.getElementById(poseId);
    const valueDisplay = document.getElementById(poseId + 'Value');
    const value = parseInt(slider.value);
    valueDisplay.textContent = (value / 1000).toFixed(3);

    // å¦‚æœä¸æ˜¯åœ†å¼§æ¨¡å¼ï¼Œåˆ™å‘é€ä½å§¿æŒ‡ä»¤
    if (!document.getElementById('poseC').checked) {
        if (poseChangeTimeout) {
            clearTimeout(poseChangeTimeout);
        }
        poseChangeTimeout = setTimeout(() => {
            sendPoseCommand();
        }, 100);
    }
}

// å¤„ç†ä½å§¿æ¨¡å¼å˜åŒ–
function handlePoseModeChange() {
    const isArcMode = document.getElementById('poseC').checked;
    document.getElementById('arcControls').style.display = isArcMode ? 'block' : 'none';
}
// å‘é€ä½å§¿æŒ‡ä»¤
async function sendPoseCommand() {
    if (!systemEnabled) {
        showMessage('è¯·å…ˆä½¿èƒ½ç³»ç»Ÿ', 'error');
        return;
    }

    const poseMode = document.querySelector('input[name="poseMode"]:checked').value;
    const poseData = {
        x: parseInt(document.getElementById('poseX').value),
        y: parseInt(document.getElementById('poseY').value),
        z: parseInt(document.getElementById('poseZ').value),
        rx: parseInt(document.getElementById('poseRX').value),
        ry: parseInt(document.getElementById('poseRY').value),
        rz: parseInt(document.getElementById('poseRZ').value),
        speed: parseInt(document.getElementById('speedRange').value)
    };

    try {
        const response = await fetch('/api/send_pose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(poseData)
        });

        const data = await response.json();
        if (!response.ok) {
            showMessage('ä½å§¿æŒ‡ä»¤å‘é€å¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showMessage('ä½å§¿æŒ‡ä»¤å‘é€å¤±è´¥: ' + error.message, 'error');
    }
}


<!-- æ··åˆæ§åˆ¶ï¼ˆæ‰‹+æœºæ¢°è‡‚ï¼‰-->
<div class="container">
    <h2>æ··åˆæ§åˆ¶ï¼ˆæ‰‹+æœºæ¢°è‡‚ï¼‰</h2>
    <div>
        <label>æ··åˆè¾“å…¥ï¼ˆå¦‚ [
            [["can0"],[1,4],[0.1,0.2]],
            [["can1"],[1,3],[0.2,0.5]],
            [["can2"],[20,1]],
            [["can3"],[70,1]]
        ] ï¼‰:</label><br>
        <textarea id="mixedInput" style="width: 100%; height: 120px;">[
    [["can0"],[1,4],[0.1,0.2]],
    [["can1"],[1,3],[0.2,0.5]],
    [["can2"],[20,1]],
    [["can3"],[70,1]]
]</textarea>
        <button class="btn btn-success" onclick="handleMixedInput()">å‘é€æ··åˆæŒ‡ä»¤</button>
    </div>
</div>


// ========== æ··åˆè¾“å…¥å¤„ç† ==========
// ç‹¬ç«‹é˜Ÿåˆ—å’ŒçŠ¶æ€ï¼Œç¡®ä¿can0/can1/can2/can3äº’ä¸å¹²æ‰°
const handQueues = { can0: [], can1: [] };
const handProcessing = { can0: false, can1: false };
const handStates = {
    can0: [0x01,0, 240, 240, 240, 240, 240, 110],
    can1: [0x01,0, 240, 240, 240, 240, 240, 110]
};
const handTimers = { can0: {}, can1: {} };

const armQueues = { can2: [], can3: [] };
const armProcessing = { can2: false, can3: false };

function handleMixedInput() {
    const input = document.getElementById("mixedInput").value.trim();
    let sequenceArray;
    try {
        sequenceArray = JSON.parse(input);
        if (!Array.isArray(sequenceArray)) throw new Error("æ ¼å¼ä¸å¯¹");
    } catch (e) {
        alert("è¾“å…¥æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼");
        return;
    }
    // åˆ†ç±»
    for (const item of sequenceArray) {
        if (!Array.isArray(item) || item.length < 2) continue;
        const can = item[0][0];
        if (can === "can0" || can === "can1") {
            handQueues[can].push(item);
            if (!handProcessing[can]) processHandQueue(can);
        } else if (can === "can2" || can === "can3") {
            armQueues[can].push(item);
            if (!armProcessing[can]) processArmQueue(can);
        }
    }
}
// æ‰‹æŒ‡åŠ¨ä½œå¤„ç†
function processHandQueue(can) {
    if (handQueues[can].length === 0) {
        handProcessing[can] = false;
        return;
    }
    handProcessing[can] = true;
    const item = handQueues[can].shift();
    const fingers = item[1];
    const durations = item[2];
    // è®¾ç½®æ¯ä¸ªæ‰‹æŒ‡ä¸º"æŒ‰ä¸‹"çŠ¶æ€ï¼ˆå€¼200ï¼‰
    fingers.forEach(fid => {
        const index = fid + 2;
        handStates[can][index] = 200;
    });
    sendCANStateWithCan(can);
    // ä¸ºæ¯ä¸ªæ‰‹æŒ‡è®¾ç½®"æŠ¬èµ·"å®šæ—¶å™¨
    fingers.forEach((fid, i) => {
        const duration = durations[i] * 1000;
        const index = fid + 2;
        if (handTimers[can][index]) clearTimeout(handTimers[can][index]);
        handTimers[can][index] = setTimeout(() => {
            handStates[can][index] = 240;
            sendCANStateWithCan(can);
            delete handTimers[can][index];
        }, duration);
    });
    setTimeout(() => {
        processHandQueue(can);
    }, Math.max(...durations) * 1000 + 50);
}
function sendCANStateWithCan(can) {
    const canMessage = {
        interface: can,
        id: 0x28,
        data: handStates[can]
    };
    fetch('/api/hand/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(canMessage)
    });
}
// æœºæ¢°è‡‚åŠ¨ä½œå¤„ç†
function processArmQueue(can) {
    if (armQueues[can].length === 0) {
        armProcessing[can] = false;
        return;
    }
    armProcessing[can] = true;
    const item = armQueues[can].shift();
    const y = item[1][0];
    const t = item[1][1];
    // ç»„åŒ…å¹¶å‘é€
    sendYSequenceWithCan(can, y, t).then(() => {
        setTimeout(() => {
            processArmQueue(can);
        }, t * 1000 + 50);
    });
}
async function sendYSequenceWithCan(can, y, t) {
    // å›ºå®šx,z,rx,ry,rzï¼Œyå•ä½ä¸ºåº¦ï¼Œè½¬åƒåˆ†ä¹‹ä¸€åº¦
    const sendSeq = [[Math.round(y * 1000), t * 1000]];
    try {
        const response = await fetch('/api/arm/y_sequence', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({sequence: sendSeq, interface: can})
        });
        const data = await response.json();
        if (!response.ok) {
            showMessage('æœºæ¢°è‡‚æŒ‡ä»¤å‘é€å¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showMessage('æœºæ¢°è‡‚æŒ‡ä»¤å‘é€å¤±è´¥: ' + error.message, 'error');
    }
}
